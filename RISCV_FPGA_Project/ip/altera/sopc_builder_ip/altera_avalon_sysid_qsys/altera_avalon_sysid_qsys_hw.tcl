# TCL File Generated by Component Editor 10.1
# Fri Jul 30 09:09:09 MKBNN 2008
# DO NOT MODIFY


# +-----------------------------------
# | 
# |    ./altera_avalon_sysid_qsys.v syn, sim
# | 
# +-----------------------------------

# +-----------------------------------
# | request TCL package from ACDS 10.1
# | 
package require -exact altera_terp 1.0
package require -exact sopc 10.1
# | 
# +-----------------------------------

# +-----------------------------------
# | module altera_avalon_sysid_qsys
# | 
set_module_property NAME altera_avalon_sysid_qsys
set_module_property VERSION 13.1
set_module_property INTERNAL false
set_module_property OPAQUE_ADDRESS_MAP true
set_module_property GROUP "Peripherals/Debug and Performance"
set_module_property AUTHOR "Altera Corporation"
set_module_property DISPLAY_NAME "System ID Peripheral"
set_module_property INSTANTIATE_IN_SYSTEM_MODULE true
set_module_property EDITABLE false
set_module_property ANALYZE_HDL false
set_module_property GENERATION_CALLBACK generate
set_module_property VALIDATION_CALLBACK validate
set_module_property ELABORATION_CALLBACK elaborate
set_module_property SIMULATION_MODEL_IN_VERILOG true
set_module_property SIMULATION_MODEL_IN_VHDL true
set_module_property HIDE_FROM_SOPC true
# | 
# +-----------------------------------

# +-----------------------------------
# | files
# | 
# | 
# +-----------------------------------

# +-----------------------------------
# | documentation links
# | 
add_documentation_link "Data Sheet" http://www.altera.com/literature/hb/nios2/n2cpu_nii51014.pdf
# | 
# +-----------------------------------

# +-----------------------------------
# | parameters
# | 
add_parameter id INTEGER 0
set_parameter_property id DEFAULT_VALUE 0
set_parameter_property id DISPLAY_NAME "32 bit System ID"
set_parameter_property id TYPE INTEGER
set_parameter_property id UNITS None
set_parameter_property id AFFECTS_GENERATION true
set_parameter_property id HDL_PARAMETER false
add_parameter timestamp INTEGER 0
set_parameter_property timestamp DEFAULT_VALUE 0
set_parameter_property timestamp DISPLAY_NAME "Time stamp"
set_parameter_property timestamp TYPE INTEGER
set_parameter_property timestamp UNITS None
set_parameter_property timestamp AFFECTS_GENERATION true
set_parameter_property timestamp HDL_PARAMETER false
set_parameter_property timestamp SYSTEM_INFO GENERATION_ID
set_parameter_property timestamp ENABLED false                                                                                       
set_parameter_property timestamp VISIBLE false 
set_parameter_property timestamp DERIVED true
# | 
# +-----------------------------------

# +-----------------------------------
# | display items
# |
add_display_item "" id PARAMETER  
set_display_item_property id DISPLAY_HINT hexadecimal
add_display_item "Description" id text "Please use hexadecimal numbers only in System ID."
# | 
# +-----------------------------------

# +-----------------------------------
# | connection point clk
# | 
add_interface clk clock end
set_interface_property clk clockRate 0

set_interface_property clk ENABLED true

add_interface_port clk clock clk Input 1
# | 
# +-----------------------------------

# +-----------------------------------
# | connection point reset
# | 
add_interface reset reset end
set_interface_property reset associatedClock clk
set_interface_property reset synchronousEdges DEASSERT

set_interface_property reset ENABLED true

add_interface_port reset reset_n reset_n Input 1
# | 
# +-----------------------------------

# +-----------------------------------
# | connection point control_slave
# | 
add_interface control_slave avalon end
set_interface_property control_slave addressAlignment DYNAMIC
set_interface_property control_slave associatedClock clk
set_interface_property control_slave burstOnBurstBoundariesOnly false
set_interface_property control_slave explicitAddressSpan 0
set_interface_property control_slave holdTime 0
set_interface_property control_slave isMemoryDevice false
set_interface_property control_slave isNonVolatileStorage false
set_interface_property control_slave linewrapBursts false
set_interface_property control_slave maximumPendingReadTransactions 0
set_interface_property control_slave printableDevice false
set_interface_property control_slave readLatency 0
set_interface_property control_slave readWaitTime 1
set_interface_property control_slave setupTime 0
set_interface_property control_slave timingUnits Cycles
set_interface_property control_slave writeWaitTime 0

set_interface_property control_slave ENABLED true

set svd_path [file join $::env(QUARTUS_ROOTDIR) .. ip altera sopc_builder_ip altera_avalon_sysid_qsys altera_avalon_sysid_qsys.svd]
set_interface_property control_slave CMSIS_SVD_FILE $svd_path

add_interface_port control_slave readdata readdata Output 32
add_interface_port control_slave address address Input 1
# | 
# +-----------------------------------


proc validate {} {

	set id           [ format %u [ get_parameter_value id ] ]
	set timestamp    [ format %u [ get_parameter_value timestamp ] ]

	#
	# Software assignments for system.h
	#
	set_module_assignment embeddedsw.CMacro.ID		$id
	set_module_assignment embeddedsw.CMacro.TIMESTAMP	$timestamp
	
	# Device tree parameters
	set_module_assignment embeddedsw.dts.vendor "altr"
	set_module_assignment embeddedsw.dts.group "sysid"
	set_module_assignment embeddedsw.dts.name "sysid"
	set_module_assignment embeddedsw.dts.compatible "altr,sysid-1.0"
	set_module_assignment embeddedsw.dts.params.id   $id
	set_module_assignment embeddedsw.dts.params.timestamp   $timestamp

	# Remind the user to set system id
	send_message info "System ID is not assigned automatically. Edit the System ID parameter to provide a unique ID"
	# Explain that timestamp will only be known during generation thus will not be shown
	send_message info "Time stamp will be automatically updated when this component is generated."

}

proc elaborate {} {
    
    set id           [ format %x [ get_parameter_value id ] ]
    set timestamp    [ format %x [ get_parameter_value timestamp ] ]

    set_interface_property control_slave CMSIS_SVD_VARIABLES "sysid_id_value=0x$id"
    set_interface_property control_slave CMSIS_SVD_VARIABLES "sysid_timestamp_value=0x$timestamp"

}


proc generate {} {

	set id            [ format %u [ get_parameter_value id ] ]
	set timestamp     [ format %u [ get_parameter_value timestamp ] ]
	set extension	".v"

	set module_dir	[ get_module_property MODULE_DIRECTORY ]
	set module_name	[ get_module_property NAME ]
	set module_filename	"${module_name}${extension}.terp"
	set module_filepath	[ file join $module_dir $module_filename ]

	set output_dir	[ get_generation_property OUTPUT_DIRECTORY ]
	set output_name	[ get_generation_property OUTPUT_NAME ]
	set output_filename	"${output_name}${extension}"
	set output_filepath	[ file join $output_dir $output_filename ]

	
	#
	# Setup parameter map
	#
	set params(OUTPUT_NAME)	$output_name
	set params(ID)		$id	
	set params(TIMESTAMP)	$timestamp

	#
	# Generate HDL
	#
	set module_template	[ read [ open $module_filepath r ] ]
	set output_content	[ altera_terp $module_template params ]
	set output_handle	[ open $output_filepath w ]

	puts $output_handle $output_content
	close $output_handle

	add_file $output_filepath {SYNTHESIS SIMULATION}
}

